# Taskfile.yml - Automation Engine
# Modern Make replacement written in Go
# Docs: https://taskfile.dev
# Usage: task <command>

version: '3'

vars:
  PROJECT_DIR: '{{.USER_WORKING_DIR}}'
  CONFIG_DIR: '{{.HOME}}/.config'

# =============================================================================
# MAIN TASKS
# =============================================================================
tasks:
  default:
    desc: "Show available tasks"
    cmds:
      - task --list

  # ===========================================================================
  # STAGED INSTALLATION (Recommended for testing)
  # ===========================================================================
  # Run stages in order: task stage:1 && task stage:2 && ...
  # Or run all at once: task setup

  stage:1:
    desc: "Stage 1: Core tools (git, jj, just, mise, task)"
    cmds:
      - task: stage:1:install
      - task: stage:1:verify

  stage:1:install:
    desc: "Install Stage 1 packages"
    cmds:
      - 'echo "=== Stage 1: Installing core tools ==="'
      - brew bundle install --file=brew/01-core.Brewfile --no-lock

  stage:1:verify:
    desc: "Verify Stage 1 installation"
    cmds:
      - echo "=== Verifying Stage 1 ==="
      - command -v git && git --version
      - command -v git-lfs && git-lfs --version | head -1
      - command -v jj && jj --version
      - command -v just && just --version
      - command -v mise && mise --version
      - command -v task && task --version
      - echo "✓ Stage 1 complete"

  stage:2:
    desc: "Stage 2: Modern CLI tools (ripgrep, fd, bat, etc.)"
    cmds:
      - task: stage:2:install
      - task: stage:2:verify

  stage:2:install:
    desc: "Install Stage 2 packages"
    cmds:
      - 'echo "=== Stage 2: Installing CLI tools ==="'
      - brew bundle install --file=brew/02-cli.Brewfile --no-lock

  stage:2:verify:
    desc: "Verify Stage 2 installation"
    cmds:
      - echo "=== Verifying Stage 2 ==="
      - command -v rg && rg --version | head -1
      - command -v fd && fd --version
      - command -v bat && bat --version | head -1
      - command -v eza && eza --version | head -1
      - command -v fzf && fzf --version
      - command -v jq && jq --version
      - command -v starship && starship --version
      - command -v yq && yq --version | head -1
      - command -v dust && dust --version | head -1
      - command -v duf && duf --version | head -1
      - command -v procs && procs --version | head -1
      - command -v btm && btm --version | head -1
      - command -v hyperfine && hyperfine --version | head -1
      - command -v xh && xh --version | head -1
      - command -v sd && sd --version | head -1
      - command -v tokei && tokei --version | head -1
      - echo "✓ Stage 2 complete"

  stage:3:
    desc: "Stage 3: Terminal & tmux (Ghostty, fonts)"
    cmds:
      - task: stage:3:install
      - task: stage:3:verify

  stage:3:install:
    desc: "Install Stage 3 packages"
    cmds:
      - 'echo "=== Stage 3: Installing terminal tools ==="'
      - brew bundle install --file=brew/03-terminal.Brewfile --no-lock

  stage:3:verify:
    desc: "Verify Stage 3 installation"
    cmds:
      - echo "=== Verifying Stage 3 ==="
      - command -v tmux && tmux -V
      - test -d "/Applications/Ghostty.app" && echo "Ghostty installed" || echo "Ghostty not found (may need manual install)"
      - command -v zellij && zellij --version | head -1 || true
      - fc-list 2>/dev/null | grep -qi "JetBrainsMono Nerd" && echo "✓ Nerd Font installed" || echo "⚠ Nerd Font not found"
      - echo "✓ Stage 3 complete"

  stage:4:
    desc: "Stage 4: Containers (OrbStack, kubectl, helm)"
    cmds:
      - task: stage:4:install
      - task: stage:4:verify

  stage:4:install:
    desc: "Install Stage 4 packages"
    cmds:
      - 'echo "=== Stage 4: Installing container tools ==="'
      - brew bundle install --file=brew/04-containers.Brewfile --no-lock

  stage:4:verify:
    desc: "Verify Stage 4 installation"
    cmds:
      - echo "=== Verifying Stage 4 ==="
      - test -d "/Applications/OrbStack.app" && echo "OrbStack installed" || echo "OrbStack not found"
      - command -v docker && docker --version || echo "Docker CLI not available (start OrbStack)"
      - command -v kubectl && kubectl version --client 2>/dev/null | head -1 || true
      - command -v helm && helm version --short || true
      - command -v kubectx && echo "kubectx available" || true
      - command -v k9s && k9s version --short 2>/dev/null || true
      - command -v lazydocker && lazydocker --version | head -1 || true
      - echo "✓ Stage 4 complete"

  stage:5:
    desc: "Stage 5: Database clients (psql, redis-cli)"
    cmds:
      - task: stage:5:install
      - task: stage:5:verify

  stage:5:install:
    desc: "Install Stage 5 packages"
    cmds:
      - 'echo "=== Stage 5: Installing database clients ==="'
      - brew bundle install --file=brew/05-databases.Brewfile --no-lock

  stage:5:verify:
    desc: "Verify Stage 5 installation"
    cmds:
      - echo "=== Verifying Stage 5 ==="
      - command -v psql && psql --version
      - command -v redis-cli && redis-cli --version
      - echo "✓ Stage 5 complete"

  stage:6:
    desc: "Stage 6: Cloud/AWS tools (awscli, granted)"
    cmds:
      - task: stage:6:install
      - task: stage:6:verify

  stage:6:install:
    desc: "Install Stage 6 packages"
    cmds:
      - 'echo "=== Stage 6: Installing cloud tools ==="'
      - brew bundle install --file=brew/06-cloud.Brewfile --no-lock

  stage:6:verify:
    desc: "Verify Stage 6 installation"
    cmds:
      - echo "=== Verifying Stage 6 ==="
      - command -v aws && aws --version
      - command -v granted && granted --version || echo "granted installed (use 'assume' command)"
      - command -v session-manager-plugin && echo "SSM plugin available" || echo "⚠ SSM plugin not installed"
      - echo "✓ Stage 6 complete"

  stage:7:
    desc: "Stage 7: AI tools (Cursor)"
    cmds:
      - task: stage:7:install
      - task: stage:7:verify

  stage:7:install:
    desc: "Install Stage 7 packages"
    cmds:
      - 'echo "=== Stage 7: Installing AI tools ==="'
      - brew bundle install --file=brew/07-ai.Brewfile --no-lock

  stage:7:verify:
    desc: "Verify Stage 7 installation"
    cmds:
      - echo "=== Verifying Stage 7 ==="
      - test -d "/Applications/Cursor.app" && echo "Cursor installed" || echo "Cursor not found"
      - echo "✓ Stage 7 complete"

  stage:8:
    desc: "Stage 8: Security tools (age, sops, trivy)"
    cmds:
      - task: stage:8:install
      - task: stage:8:verify

  stage:8:install:
    desc: "Install Stage 8 packages"
    cmds:
      - 'echo "=== Stage 8: Installing security tools ==="'
      - brew bundle install --file=brew/08-security.Brewfile --no-lock

  stage:8:verify:
    desc: "Verify Stage 8 installation"
    cmds:
      - echo "=== Verifying Stage 8 ==="
      - command -v age && age --version
      - command -v sops && sops --version | head -1
      - command -v trivy && trivy --version | head -1
      - command -v cosign && cosign version 2>/dev/null | head -1
      - echo "✓ Stage 8 complete"

  stage:9:
    desc: "Stage 9: Build tools (cmake, ninja, golangci-lint)"
    cmds:
      - task: stage:9:install
      - task: stage:9:verify

  stage:9:install:
    desc: "Install Stage 9 packages"
    cmds:
      - 'echo "=== Stage 9: Installing build tools ==="'
      - brew bundle install --file=brew/09-build.Brewfile --no-lock

  stage:9:verify:
    desc: "Verify Stage 9 installation"
    cmds:
      - echo "=== Verifying Stage 9 ==="
      - command -v cmake && cmake --version | head -1
      - command -v ninja && ninja --version
      - command -v golangci-lint && golangci-lint --version | head -1
      - command -v ccache && ccache --version | head -1
      - echo "✓ Stage 9 complete"

  stage:runtimes:
    desc: "Stage R: Language runtimes via mise (Go, Python, Rust, Bun)"
    cmds:
      - task: stage:runtimes:install
      - task: stage:runtimes:verify

  stage:runtimes:install:
    desc: "Install language runtimes"
    cmds:
      - echo "=== Installing runtimes via mise ==="
      - mise install --yes

  stage:runtimes:verify:
    desc: "Verify runtime installation"
    cmds:
      - echo "=== Verifying runtimes ==="
      - mise current
      - go version || echo "Go not installed"
      - rustc --version || echo "Rust not installed"
      - python --version || echo "Python not installed"
      - bun --version || echo "Bun not installed"
      - uv --version || echo "uv not installed"
      - deno --version | head -1 || echo "Deno not installed"
      - terraform --version | head -1 || echo "Terraform not installed"
      - echo "✓ Runtimes complete"

  stage:configs:
    desc: "Stage C: Apply all configurations (shell, git, tmux, ghostty)"
    cmds:
      - task: config:shell
      - task: config:git
      - task: config:tmux
      - task: config:ghostty
      - echo "✓ Configs complete"

  stage:databases:
    desc: "Stage D: Start database containers"
    cmds:
      - task: db:up
      - task: db:wait
      - echo "✓ Databases running"

  stage:ai-tools:
    desc: "Stage AI: Install AI coding CLI tools"
    cmds:
      - task: stage:ai-tools:install
      - task: stage:ai-tools:verify

  stage:ai-tools:install:
    desc: "Install AI coding tools (Claude Code, OpenCode, Codex, Gemini CLI)"
    cmds:
      - echo "=== Installing AI coding tools ==="
      - 'echo "Priority order: curl → mise → bun → npm → homebrew"'
      - echo ""
      - |
        echo "--- Claude Code (curl installer - npm is deprecated) ---"
        if command -v claude &>/dev/null; then
          echo "✓ Claude Code already installed: $(claude --version 2>/dev/null | head -1)"
        else
          echo "Installing Claude Code via curl..."
          curl -fsSL https://claude.ai/install.sh | bash || echo "⚠ Claude Code install failed - try manually"
        fi
      - |
        echo ""
        echo "--- OpenCode, Codex, Gemini CLI (via mise) ---"
        mise install opencode || echo "⚠ OpenCode install failed"
        mise install npm:@openai/codex || echo "⚠ Codex install failed"
        mise install npm:@google/gemini-cli || echo "⚠ Gemini CLI install failed"
      - echo ""
      - echo "✓ AI tools installation complete"

  stage:ai-tools:verify:
    desc: "Verify AI tools installation"
    cmds:
      - echo "=== Verifying AI tools ==="
      - 'command -v claude && claude --version 2>/dev/null | head -1 || echo "⚠ Claude Code not found"'
      - 'command -v opencode && opencode --version 2>/dev/null | head -1 || echo "⚠ OpenCode not found"'
      - 'mise exec -- codex --version 2>/dev/null | head -1 || echo "⚠ Codex not found"'
      - 'mise exec -- gemini --version 2>/dev/null | head -1 || echo "⚠ Gemini CLI not found"'
      - echo "✓ AI tools verification complete"

  # ===========================================================================
  # FULL SETUP (All stages)
  # ===========================================================================
  setup:
    desc: "Full environment setup (all stages)"
    cmds:
      - task: setup:brew
      - task: stage:runtimes
      - task: stage:configs
      - task: verify

  setup:brew:
    desc: "Install all Homebrew packages (stages 1-9)"
    cmds:
      - task: stage:1
      - task: stage:2
      - task: stage:3
      - task: stage:4
      - task: stage:5
      - task: stage:6
      - task: stage:7
      - task: stage:8
      - task: stage:9

  setup:minimal:
    desc: "Minimal setup (core + CLI + runtimes only)"
    cmds:
      - task: stage:1
      - task: stage:2
      - task: stage:runtimes
      - task: config:shell
      - task: config:git
      - echo "✓ Minimal setup complete"

  setup:developer:
    desc: "Developer setup (minimal + terminal + containers)"
    cmds:
      - task: setup:minimal
      - task: stage:3
      - task: stage:4
      - task: stage:9
      - task: config:tmux
      - task: config:ghostty
      - echo "✓ Developer setup complete"

  setup:full:
    desc: "Full setup (everything including AI and databases)"
    cmds:
      - task: setup:developer
      - task: stage:5
      - task: stage:6
      - task: stage:7
      - task: stage:8
      - task: stage:ai-tools
      - task: stage:databases
      - echo "✓ Full setup complete"

  # ===========================================================================
  # LEGACY ALIASES (for backwards compatibility)
  # ===========================================================================
  brew:
    desc: "Install all Homebrew packages (alias for setup:brew)"
    cmds:
      - task: setup:brew

  runtimes:
    desc: "Install language runtimes (alias for stage:runtimes)"
    cmds:
      - task: stage:runtimes

  configs:
    desc: "Apply configurations (alias for stage:configs)"
    cmds:
      - task: stage:configs

  # ===========================================================================
  # CONFIGURATION TASKS
  # ===========================================================================
  config:ghostty:
    desc: "Install Ghostty configuration"
    cmds:
      - mkdir -p {{.CONFIG_DIR}}/ghostty
      - cp config/ghostty.conf {{.CONFIG_DIR}}/ghostty/config
      - echo "Ghostty config installed to {{.CONFIG_DIR}}/ghostty/config"

  config:tmux:
    desc: "Install tmux configuration"
    cmds:
      - cp config/tmux.conf {{.HOME}}/.tmux.conf
      - |
        if [ ! -d ~/.tmux/plugins/tpm ]; then
          git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
        fi
      - ~/.tmux/plugins/tpm/bin/install_plugins || true
      - echo "Tmux config installed"

  config:shell:
    desc: "Configure shell (zsh)"
    cmds:
      - |
        grep -q "mise activate zsh" ~/.zshrc 2>/dev/null || echo 'eval "$(mise activate zsh)"' >> ~/.zshrc
        grep -q "starship init zsh" ~/.zshrc 2>/dev/null || echo 'eval "$(starship init zsh)"' >> ~/.zshrc
        grep -q "zoxide init zsh" ~/.zshrc 2>/dev/null || echo 'eval "$(zoxide init zsh)"' >> ~/.zshrc
      - echo "Shell config updated"

  config:git:
    desc: "Configure git with modern defaults"
    cmds:
      - git config --global init.defaultBranch main
      - git config --global pull.rebase true
      - git config --global fetch.prune true
      - git config --global diff.colorMoved zebra
      - git config --global core.pager delta
      - git config --global interactive.diffFilter "delta --color-only"
      - git config --global merge.conflictstyle diff3
      - git config --global diff.algorithm histogram
      - echo "Git config updated"

  verify:
    desc: "Verify full environment setup"
    cmds:
      - echo "=== Full Environment Verification ==="
      - task: stage:1:verify
      - task: stage:2:verify
      - task: stage:runtimes:verify
      - echo "=== All verifications passed ==="

  # ===========================================================================
  # DATABASE TASKS
  # ===========================================================================
  db:up:
    desc: "Start all databases"
    cmds:
      - docker compose -f docker/docker-compose.yml up -d
      - echo "Databases starting..."

  db:down:
    desc: "Stop all databases"
    cmds:
      - docker compose -f docker/docker-compose.yml down

  db:reset:
    desc: "Reset all databases (destructive)"
    cmds:
      - docker compose -f docker/docker-compose.yml down -v
      - task: db:up

  db:wait:
    desc: "Wait for databases to be ready"
    cmds:
      - |
        echo "Waiting for PostgreSQL..."
        timeout=60
        while ! docker exec dev-postgres pg_isready -U dev 2>/dev/null; do
          sleep 1
          timeout=$((timeout - 1))
          if [ $timeout -le 0 ]; then
            echo "PostgreSQL timeout"
            exit 1
          fi
        done
        echo "PostgreSQL ready"
      - |
        echo "Waiting for Redis..."
        timeout=60
        while ! docker exec dev-redis redis-cli -a dev ping 2>/dev/null | grep -q PONG; do
          sleep 1
          timeout=$((timeout - 1))
          if [ $timeout -le 0 ]; then
            echo "Redis timeout"
            exit 1
          fi
        done
        echo "Redis ready"
      - echo "All databases ready!"

  db:psql:
    desc: "Connect to PostgreSQL"
    cmds:
      - docker exec -it dev-postgres psql -U dev

  db:redis:
    desc: "Connect to Redis CLI"
    cmds:
      - docker exec -it dev-redis redis-cli -a dev

  db:status:
    desc: "Check database container status"
    cmds:
      - docker compose -f docker/docker-compose.yml ps

  # ===========================================================================
  # SANDBOX TASKS (AI Agent Isolation)
  # ===========================================================================
  sandbox:basic:
    desc: "Run command in basic sandbox (file restrictions)"
    cmds:
      - |
        sandbox-exec -f sandbox/basic.sb \
          -D HOME="$HOME" \
          -D PROJECT_DIR="{{.PROJECT_DIR}}" \
          {{.CLI_ARGS}}

  sandbox:container:
    desc: "Run command in container sandbox"
    cmds:
      - |
        docker run --rm -it \
          --cap-drop=ALL \
          --cap-add=CHOWN \
          --cap-add=SETUID \
          --cap-add=SETGID \
          --security-opt=no-new-privileges \
          --network=host \
          -v "{{.PROJECT_DIR}}:/workspace:rw" \
          -v "$HOME/.config/claude:/home/agent/.config/claude:ro" \
          -w /workspace \
          ai-sandbox \
          {{.CLI_ARGS}}

  sandbox:vm:
    desc: "Run command in OrbStack Linux VM (full isolation)"
    cmds:
      - |
        orb run -m ubuntu \
          -v "{{.PROJECT_DIR}}:/workspace" \
          -- {{.CLI_ARGS}}

  sandbox:build:
    desc: "Build sandbox container image"
    cmds:
      - docker build -f sandbox/Dockerfile.agent -t ai-sandbox .

  # ===========================================================================
  # CI/CD TASKS
  # ===========================================================================
  ci:local:
    desc: "Run CI locally (same as GitHub Actions)"
    cmds:
      - task: lint
      - task: test
      - task: build

  ci:runner:local:
    desc: "Setup self-hosted runner on this Mac"
    cmds:
      - chmod +x ci/runner-local.sh
      - 'echo "Run: ./ci/runner-local.sh <GITHUB_TOKEN> <REPO_URL>"'

  ci:runner:aws:
    desc: "Launch ephemeral runner on AWS via SkyPilot"
    cmds:
      - |
        sky launch ci/runner-aws.yaml \
          --env GITHUB_TOKEN="${GITHUB_TOKEN}" \
          --env REPO_URL="${REPO_URL}"

  # ===========================================================================
  # DEVELOPMENT TASKS
  # ===========================================================================
  lint:
    desc: "Run all linters"
    cmds:
      - task: lint:go
      - task: lint:python
      - task: lint:ts

  lint:go:
    desc: "Lint Go code"
    cmds:
      - go vet ./... || true
      - golangci-lint run || true

  lint:python:
    desc: "Lint Python code"
    cmds:
      - uv run ruff check . || true
      - uv run mypy . || true

  lint:ts:
    desc: "Lint TypeScript code"
    cmds:
      - bun run lint || true

  test:
    desc: "Run all tests"
    cmds:
      - task: test:go
      - task: test:python
      - task: test:ts

  test:go:
    desc: "Run Go tests"
    cmds:
      - go test -v -race ./... || true

  test:python:
    desc: "Run Python tests"
    cmds:
      - uv run pytest -v || true

  test:ts:
    desc: "Run TypeScript tests"
    cmds:
      - bun test || true

  build:
    desc: "Build all artifacts"
    cmds:
      - echo "Build tasks go here..."

  # ===========================================================================
  # AWS TASKS
  # ===========================================================================
  aws:login:
    desc: "Login to AWS via Granted"
    cmds:
      - assume

  aws:ssm:
    desc: "Connect to EC2 via SSM (no SSH keys needed)"
    cmds:
      - |
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Usage: task aws:ssm -- i-instanceid"
          exit 1
        fi
        aws ssm start-session --target {{.CLI_ARGS}}

  # ===========================================================================
  # CLEANUP TASKS
  # ===========================================================================
  clean:
    desc: "Clean build artifacts and caches"
    cmds:
      - go clean -cache || true
      - uv cache clean || true
      - bun pm cache rm || true
      - docker system prune -f || true

  clean:all:
    desc: "Deep clean (includes databases)"
    cmds:
      - task: clean
      - task: db:down
      - docker volume prune -f || true

  # ===========================================================================
  # HELP & INFO
  # ===========================================================================
  help:stages:
    desc: "Show staged installation guide"
    cmds:
      - |
        echo ""
        echo "=== Staged Installation Guide ==="
        echo ""
        echo "Run stages individually to test each step:"
        echo ""
        echo "  task stage:1          # Core (git, mise, task)"
        echo "  task stage:2          # CLI tools (ripgrep, fd, bat, etc.)"
        echo "  task stage:3          # Terminal (Ghostty, tmux, fonts)"
        echo "  task stage:4          # Containers (OrbStack, kubectl, helm)"
        echo "  task stage:5          # Database clients (psql, redis-cli)"
        echo "  task stage:6          # Cloud/AWS (awscli, granted)"
        echo "  task stage:7          # AI tools (Cursor)"
        echo "  task stage:8          # Security (age, sops, trivy)"
        echo "  task stage:9          # Build tools (cmake, ninja)"
        echo "  task stage:runtimes   # Languages (Go, Python, Rust, Bun)"
        echo "  task stage:configs    # Config files (shell, git, tmux)"
        echo "  task stage:databases  # Start database containers"
        echo "  task stage:ai-tools   # Claude Code and AI tools"
        echo ""
        echo "Or use preset bundles:"
        echo ""
        echo "  task setup:minimal    # Core + CLI + runtimes"
        echo "  task setup:developer  # Minimal + terminal + containers + build"
        echo "  task setup:full       # Everything including AI and databases"
        echo ""
        echo "Verify any stage with: task stage:N:verify"
        echo ""

  # ===========================================================================
  # VALIDATION TASKS
  # ===========================================================================
  validate:
    desc: "Run all validation checks"
    deps:
      - validate:taskfile
      - validate:mise
      - validate:brewfiles
      - validate:runtimes
    cmds:
      - echo "✓ All validation checks passed"

  validate:all:
    desc: "Run comprehensive validation (includes slow checks)"
    cmds:
      - chmod +x scripts/validate.sh
      - ./scripts/validate.sh

  validate:taskfile:
    desc: "Validate Taskfile.yml against JSON schema"
    cmds:
      - mise exec -- uvx check-jsonschema --builtin-schema vendor.taskfile Taskfile.yml

  validate:mise:
    desc: "Validate mise.toml for deprecation warnings"
    cmds:
      - |
        echo "=== Validating mise.toml ==="
        output=$(mise ls 2>&1)
        if echo "$output" | grep -q "WARN"; then
          echo "ERROR: mise.toml has warnings:"
          echo "$output" | grep "WARN"
          exit 1
        fi
        echo "✓ No deprecation warnings in mise.toml"

  validate:brewfiles:
    desc: "Validate all Brewfiles"
    cmds:
      - |
        echo "=== Validating Brewfiles ==="
        for f in Brewfile brew/*.Brewfile; do
          if [ -f "$f" ]; then
            ruby -c "$f" && echo "✓ $f"
          fi
        done
      - |
        echo "=== Checking for task/go-task conflict ==="
        # Use word boundary to match exact 'brew "task"' but not 'brew "go-task"'
        if grep -E 'brew "[^"]*\btask"' Brewfile brew/*.Brewfile 2>/dev/null | grep -v 'go-task'; then
          echo "ERROR: Found 'brew \"task\"' (Taskwarrior) - should be 'brew \"go-task\"'"
          exit 1
        fi
        echo "✓ No task/go-task naming conflicts"

  validate:formulas:
    desc: "Check if all Homebrew formulas exist"
    cmds:
      - |
        echo "=== Checking formula availability ==="
        errors=0
        for brewfile in Brewfile brew/*.Brewfile; do
          if [ -f "$brewfile" ]; then
            echo "Checking $brewfile..."
            formulas=$(grep -E '^brew "' "$brewfile" | sed 's/brew "\([^"]*\)".*/\1/')
            for formula in $formulas; do
              if ! brew info "$formula" &>/dev/null; then
                echo "ERROR: Formula not found in $brewfile: $formula"
                errors=$((errors + 1))
              fi
            done
            casks=$(grep -E '^cask "' "$brewfile" | sed 's/cask "\([^"]*\)".*/\1/')
            for cask in $casks; do
              if ! brew info --cask "$cask" &>/dev/null; then
                echo "ERROR: Cask not found in $brewfile: $cask"
                errors=$((errors + 1))
              fi
            done
          fi
        done
        if [ $errors -gt 0 ]; then
          echo "ERROR: $errors formula/cask(s) not found"
          exit 1
        fi
        echo "✓ All formulas and casks exist"

  validate:yaml:
    desc: "Lint YAML files"
    cmds:
      - mise exec -- uvx yamllint -d relaxed Taskfile.yml || true
      - mise exec -- uvx yamllint -d relaxed docker/*.yml || true
      - mise exec -- uvx yamllint -d relaxed .github/workflows/*.yml || true

  validate:runtimes:
    desc: "Verify mise-managed runtimes are installed correctly"
    cmds:
      - |
        echo "=== Verifying mise-managed runtimes ==="
        errors=0
        warnings=0

        # Tools that should be managed by mise (not Homebrew)
        # Format: tool_name:binary_name (binary defaults to tool_name if not specified)
        mise_tools="bun node python go rust:rustc deno terraform uv"

        for entry in $mise_tools; do
          tool="${entry%%:*}"
          binary="${entry#*:}"
          # If no colon, binary equals tool
          if [ "$binary" = "$entry" ]; then
            binary="$tool"
          fi

          # Check if installed via Homebrew (exact match only)
          # Use --formula to get exact match, not partial (e.g., python vs python@3.14)
          if brew list --formula 2>/dev/null | grep -qx "$tool"; then
            echo "ERROR: $tool installed via Homebrew (should use mise)"
            echo "  Fix: brew uninstall $tool && mise install $tool"
            errors=$((errors + 1))
          fi

          # Check if mise has this tool configured
          if grep -q "^$tool\s*=" mise.toml 2>/dev/null; then
            # Use mise ls to check if installed (works for all tools)
            if ! mise ls "$tool" 2>/dev/null | grep -q "$tool"; then
              echo "WARNING: $tool configured in mise.toml but not installed"
              echo "  Fix: mise install $tool"
              warnings=$((warnings + 1))
            else
              version=$(mise ls "$tool" 2>/dev/null | awk '{print $2}')
              echo "✓ $tool: $version"
            fi
          fi
        done

        # Check for manual bun installation
        if [ -d "$HOME/.bun" ]; then
          echo "ERROR: Manual bun installation found at ~/.bun"
          echo "  Fix: rm -rf ~/.bun && mise install bun"
          errors=$((errors + 1))
        fi

        # Summary
        if [ $errors -gt 0 ]; then
          echo "ERROR: $errors runtime conflict(s) found"
          exit 1
        fi
        if [ $warnings -gt 0 ]; then
          echo "WARNING: $warnings runtime(s) need installation"
        fi
        echo "✓ All runtimes verified"

  hooks:install:
    desc: "Install pre-commit hooks"
    cmds:
      - mise exec -- uvx pre-commit install
      - echo "✓ Pre-commit hooks installed"

  hooks:run:
    desc: "Run pre-commit on all files"
    cmds:
      - pre-commit run --all-files

  validate:test:
    desc: "Run validation test suite"
    cmds:
      - chmod +x scripts/test-validation.sh
      - ./scripts/test-validation.sh

  validate:shell:
    desc: "Test shell configuration (zsh, oh-my-zsh, mise)"
    cmds:
      - chmod +x scripts/test-shell-config.sh
      - ./scripts/test-shell-config.sh

  validate:integration:
    desc: "Run integration tests"
    cmds:
      - chmod +x scripts/test-integration.sh
      - ./scripts/test-integration.sh

  config:verify:
    desc: "Verify all configurations applied correctly"
    cmds:
      - |
        echo "=== Configuration Verification ==="
        errors=0
        echo "--- Git Config ---"
        git config --global init.defaultBranch 2>/dev/null | grep -q main && echo "✓ defaultBranch=main" || { echo "✗ defaultBranch"; errors=$((errors+1)); }
        git config --global core.pager 2>/dev/null | grep -q delta && echo "✓ pager=delta" || echo "⚠ pager not delta (optional)"
        echo "--- Shell Config ---"
        grep -q "plugins=(" ~/.zshrc && echo "✓ oh-my-zsh plugins configured" || { echo "✗ plugins not configured"; errors=$((errors+1)); }
        grep -q "mise" ~/.zshrc && echo "✓ mise in .zshrc" || { echo "✗ mise not in .zshrc"; errors=$((errors+1)); }
        echo "--- Ghostty Config ---"
        test -f ~/.config/ghostty/config && echo "✓ ghostty config exists" || echo "⚠ ghostty config missing (optional)"
        echo "--- Tmux Config ---"
        test -f ~/.tmux.conf && echo "✓ tmux config exists" || echo "⚠ tmux config missing (optional)"
        echo ""
        if [ $errors -eq 0 ]; then echo "✓ All required configurations verified"; else echo "✗ $errors configuration(s) missing"; exit 1; fi

  db:verify:
    desc: "Verify database containers and client connectivity"
    cmds:
      - task: db:status
      - |
        echo "=== Database Client Verification ==="
        if psql -h localhost -U dev -d dev -c "SELECT 1;" &>/dev/null; then echo "✓ PostgreSQL client works"; else echo "✗ PostgreSQL client failed"; exit 1; fi
        if redis-cli -h localhost -p 6379 -a dev PING 2>/dev/null | grep -q PONG; then echo "✓ Redis client works"; else echo "✗ Redis client failed"; exit 1; fi
        echo "✓ All database clients verified"

  validate:full:
    desc: "Run ALL validation checks (comprehensive)"
    cmds:
      - echo "=== Full Validation Suite ==="
      - task: validate
      - task: validate:shell
      - task: validate:integration
      - task: config:verify
      - echo ""
      - echo "✓ Full validation complete - all checks passed"
